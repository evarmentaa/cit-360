---
- hosts: web
  vars:
   db_password: password
   server_name: curriculum
   service_name: curriculum
   service_version: 1.0
   app_key: QujjaJs3fxwtnTl7FiqhEEn1ACkf7YZW
   app_env: test
   db_host: localhost
   db_database: curriculum
   db_username: curriculum
   db_port: 3306
   service_dir: /usr/share/nginx/{{ service_name }}
  tasks:
<<<<<<< HEAD
    - name: replaces the line and sets SELINUX to be permissive right away 
      become: yes
      lineinfile: dest=/etc/sysconfig/selinux regexp="^SELINUX=" line="SELINUX=permissive"

    - become: yes
      command: setenforce 0
      
    - name: Installs (EPEL) Extended Packages for Enterprise Linux
      become: yes
      yum: name=epel-release update_cache=yes state=present

    - name: Installs nginx
      become: yes
      yum: name=nginx,php,php-fpm,php-ldap,php-mbstring,php-mcrypt,php-mysql,php-phpunit-PHPUnit update_cache=yes state=present
      register: nginx_install

    - name: Downloads composer into directory
      become: yes
      shell: curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

    - name: Copy module that copies from the nginx source to /etc 
      become: yes
      copy: src=web/nginx.conf dest=/etc/nginx/nginx.conf mode=0640
      register: nginx_conf

#nothing wrong
    - name: template that injects service_name
      become: yes
      template: src=web/vhost.conf.j2 dest=/etc/nginx/conf.d/{{ service_name }}.conf mode=0644
      register: vhost_conf

#problem
    - name: 
      become: yes
      template: src=web/php.ini.j2 dest=/etc/php.ini mode=0644
      register: php_conf
#fine
    - name:
      become: yes
      copy: src=web/php-fpm-web.conf dest=/etc/php-fpm.d/www.conf mode=0644
      register: php_fpm_conf

#changes systemd to service 
    - name: 
      become: yes
      service: name=nginx state=restarted enabled=yes
      when: nginx_install|changed or nginx_conf|changed or vhost_conf|changed

    - name:
      become: yes
      service: name=php-fpm state=restarted enabled=yes
      when: nginx_install|changed or php_conf|changed or php_fpm_conf|changed

    - name:
      become: yes
      file: path="{{ service_dir }}" state=directory

    - name:
      become: yes
      unarchive: src=web/{{ service_name }}.tgz dest="{{ service_dir }}" mode=0755

    - name:
      become: yes
      command: /usr/local/bin/composer update chdir={{ service_dir }}

    - name:
      become: yes
      command: chown -R 0777 storage chdir="{{ service_dir }}"

    - name: 
      become: yes
      command: chown -R 0777 nginx:nginx chdir="{{ service_dir }}"

    - name: Template that injects service_dir 
      become: yes
      template: src=web/env.j2 dest="{{ service_dir }}/.env" mode=0644 owner=nginx
=======

- name: change
   selinux: dest=/etc/sysconfig/selinux regexp="^SELINUX=" line="SELINUX=permissive"

   become: yes
   
   command: setenforce 0 
   
- name: install epel-release
   yum: name=epel-release update_cache=yes state=present
   become: yes
   
- name: install nginx 
   yum: name=nginx,php,php-fpm,php-ldap,php-mbstring,php-mcrypt,php-mysql,php-phpunit-PHPUnit update_cache=yes state=present
   register: nginx_install
   become: yes

- name:  test webserver 
   shell: curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
   become: yes
   
- name: copy module   
   copy: src=web/nginx.conf dest=/etc/nginx/nginx.conf mode=0644
   register: nginx_conf
   become: yes

- name:   
   template: src=web/vhost.conf.j2 dest=/etc/nginx/conf.d/{{ service_name }}.conf mode=0644
   register: vhost_conf
- name:   
   template: src=web/php.ini.j2 dest=/etc/php.ini mode=0644
   register: php_conf
   become: yes
  
- name:   
   copy: src=web/php-fpm-web.conf dest=/etc/php-fpm.d/www.conf mode=0644
   register: php_fpm_conf
   become: yes

- name:    
   service: name=nginx state=restarted enabled=yes
   when: nginx_install|changed or nginx_conf|changed or vhost_conf|changed

- name:   
   service: name=php-fpm state=restarted enabled=yes
   when: nginx_install|changed or php_conf|changed or php_fpm_conf|changed   
   become: yes
   
- name:   
   file: path="{{ service_dir }}" state=file
   become: yes

- name:   
   unarchive: src=web/{{ service_name }}.tgz dest="{{ service_dir }}" mode=0744
   become: yes

- name:
   command: /usr/local/bin/composer update chdir={{ service_dir }}   
   become: yes
- name:   
   command: chmod -R 0777 storage chdir="{{ service_dir }}"

- name:   
   command: chown -R nginx:nginx . chdir="{{ service_dir }}"
   become: yes
   
- name:   
   template: src=web/env.j2 dest="{{ service_dir }}/.env" mode=0644 owner=nginx
>>>>>>> cd1cb480fdffcd5e521581d78b86a29388d65b7b

